new Vue({el:"#app",data:{id:"",shoppingList:[],merches:[],listArr:[],inputCouponCode:"",couponCode:"",discount:!1,prevSum:0},computed:{List(){return JSON.parse(JSON.stringify(this.shoppingList))},price(){let t=0;for(let s=0;s<this.shoppingList.length;s++)this.shoppingList[s].quantity?t+=parseInt(this.merches[this.shoppingList[s].id-1].merchPrice)*parseInt(this.shoppingList[s].quantity):this.shoppingList[s].quantity=0;return this.discount?t-100:(this.prevSum=t,t)}},methods:{showList(){if(this.listArr=[],this.shoppingList.length)for(let t=0;t<this.shoppingList.length;t++)this.listArr.push(this.merches[this.shoppingList[t].id-1]);console.log(this.listArr)},plus(t){this.shoppingList[t].quantity=parseInt(this.shoppingList[t].quantity)+1,console.log(this.shoppingList),axios.patch(`http://localhost:5000/members/${this.id}`,{shoppingCart:this.shoppingList}).then((t=>{console.log(t)}))},minus(t){this.shoppingList[t].quantity=parseInt(this.shoppingList[t].quantity)-1,this.shoppingList[t].quantity<1&&this.deleteItem(t,!0),console.log(this.shoppingList),axios.patch(`http://localhost:5000/members/${this.id}`,{shoppingCart:this.shoppingList}).then((t=>{console.log(t)}))},deleteItem(t,s){swal.fire({title:"從購物車刪除此商品?",showCancelButton:!0,icon:"question"}).then((i=>{i.value?(console.log(t),this.shoppingList.splice(t,1),axios.patch(`http://localhost:5000/members/${this.id}`,{shoppingCart:this.shoppingList}).then((t=>{console.log(t)})),this.showList(),console.log(this.shoppingList)):s&&(this.shoppingList[t].quantity=1)}))},purchase(){let t=new Date,s=this.prevSum;this.discount&&(s-=100,axios.patch(`http://localhost:5000/members/${this.id}`,{coupon:"used"}).then((t=>{console.log(t)}))),axios.post("http://localhost:5000/orders",{member_id:this.id,order_detail:this.shoppingList,dateTime:t,total_price:s,discount:this.discount}).then((t=>{swal.fire("結帳成功!","","success"),axios.patch(`http://localhost:5000/members/${this.id}`,{shoppingCart:[]}).then((t=>{console.log(t),this.shoppingList=[],this.listArr=[]}))})).catch((t=>{console.log(t)}))},backToHomepage(){location.href="index.html"}},mounted(){let t=document.cookie.split(";");for(let s=0;s<t.length;s++){let i=t[s].trim();0==i.indexOf("id=")&&(this.id=i.substr(3,i.length-2),console.log(this.id))}this.id.length||(location.href="login.html"),axios.get("http://localhost:5000/merches").then((t=>{this.merches=t.data,axios.get(`http://localhost:5000/members/${this.id}`).then((t=>{this.shoppingList=t.data.shoppingCart,t.data.coupon&&(this.couponCode=t.data.coupon,console.log(this.couponCode)),this.showList()}))}))},watch:{List:{handler(t,s){if(s.length)for(let i=0;i<t.length;i++)t[i].quantity&&(this.shoppingList[i].quantity=parseInt(t[i].quantity),console.log(this.shoppingList[i].quantity),s[i].quantity!=t[i].quantity&&(t[i].quantity<0?(this.shoppingList[i].quantity=1,swal.fire("購買數量不可小於0!","","warning")):t[i].quantity>this.merches[i].quantity&&(this.shoppingList[i].quantity=parseInt(this.merches[i].quantity),swal.fire("購買數量已達上限!","","warning"))))},deep:!0},inputCouponCode:function(t){t==this.couponCode?(this.discount=!0,console.log(this.discount)):this.discount=!1}}});